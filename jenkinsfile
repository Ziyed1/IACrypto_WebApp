pipeline {
    agent any
    stages {
        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }
        stage('Build Frontend') {
            when {
                branch 'frontend'
            }
            steps {
                echo 'Building Frontend...'
                sh '''
                cd frontend
                npm install
                npm run build
                '''
            }
        }
        stage('Build Backend') {
            when {
                branch 'backend'
            }
            steps {
                echo 'Building Backend...'
                sh '''
                cd backend
                npm install
                npm run build
                '''
            }
        }
        stage('Deploy Frontend') {
            when {
                branch 'frontend'
            }
            steps {
                echo 'Deploying Frontend...'
                sshagent(['ec2-ssh-key']) {
                    sh '''
                    scp -r frontend/build/* ec2-user@<EC2_IP>:/var/www/frontend
                    ssh ec2-user@<EC2_IP> 'sudo systemctl restart nginx'
                    '''
                }
            }
        }
        stage('Deploy Backend') {
            when {
                branch 'backend'
            }
            steps {
                echo 'Deploying Backend...'
                sshagent(['ec2-ssh-key']) {
                    sh '''
                    scp -r backend/* ec2-user@<EC2_IP>:/var/www/backend
                    ssh ec2-user@<EC2_IP> 'pm2 reload all'
                    '''
                }
            }
        }
    }
    post {
        success {
            echo 'Pipeline executed successfully!'
        }
        failure {
            echo 'Pipeline failed. Please check the logs.'
        }
    }
}
